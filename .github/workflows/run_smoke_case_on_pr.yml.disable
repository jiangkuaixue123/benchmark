name: run_smoke_case_on_pr

on:
  pull_request:
    paths:
      - 'smoke_tests/test-case/**'
  workflow_dispatch:
  schedule:
    - cron:  '56 22 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PY310_VERSION: 3.10.19
  PY311_VERSION: 3.11.14
jobs:
  pr_run_smoke_cases:
    runs-on: [self-hosted, Linux, smoke]
    timeout-minutes: 20
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Get Modified Cases
        run: |
          echo "Getting modified files in smoke_tests/test-case directory..."
          # 检查是否是拉取请求事件
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # 获取当前提交与PR基础提交之间的差异文件
            git diff HEAD~1 HEAD --name-only smoke_tests/test-case/ > modified_files.txt
          else
            # 如果是其他事件（如schedule或workflow_dispatch），获取所有测试用例文件夹
            find smoke_tests/test-case/ -mindepth 3 -maxdepth 3 -type d | sed 's|smoke_tests/test-case/||' > modified_files.txt
          fi

          echo "Modified files or directories found:"
          cat modified_files.txt

          # 使用Python脚本解析出需要的文件夹名（第三级目录）
          python3 - <<END
          import os
          import re

          modified_dirs = set()

          with open('modified_files.txt', 'r') as f:
              for line in f:
                  line = line.strip()
                  if line:
                      # 解析路径，如smoke_tests/test-case/run_server_accuracy/llm_datasets_main/accuracy_aime2024
                      parts = line.split(os.path.sep)
                      # 找到第三级目录（即accuracy_aime2024这一级）
                      if len(parts) >= 4 and parts[0] == 'smoke_tests' and parts[1] == 'test-case':
                          # 获取第三级目录名
                          case_name = parts[3]
                          modified_dirs.add(case_name)

          # 输出结果到环境变量或文件（同一行用空格隔开）
          with open('modified_cases.txt', 'w') as f:
              f.write(' '.join(sorted(modified_dirs)))

          print("Modified cases identified:")
          if modified_dirs:
              print(' '.join(sorted(modified_dirs)))
          else:
              print("No relevant test case directories modified.")
          END

          echo "Modified cases saved to modified_cases.txt"

      - name: Run Modified Cases
        run: |
          source ~/miniconda3/bin/activate
          conda activate py310
          bash smoke_tests/scripts/run_steps.sh -t $(cat modified_cases.txt)
          if [ $? -ne 0 ]; then
            echo "[ERROR] Smoke test execution failed, please check the logs. "
            exit 1
          else
            echo "[INFO] Smoke test finish execution, need to check whether all test cases passed. "
          fi

      - name: Get Result files
        run: |
          # 找到最新的RunWorkspace文件夹
          RUNWORKSPACE_DIR=$(ls -td smoke_tests/RunWorkspace/* | head -1)
          echo "Found RunWorkspace directory: $RUNWORKSPACE_DIR"
          # 打包文件夹
          RUNWORKSPACE_NAME=$(basename "$RUNWORKSPACE_DIR")
          tar -czf "${RUNWORKSPACE_NAME}.tar.gz" -C "smoke_tests/RunWorkspace" "${RUNWORKSPACE_NAME}"
          echo "Packed RunWorkspace as ${RUNWORKSPACE_NAME}.tar.gz"
          # 检查是否有失败的测试用例
          if [ -d "$RUNWORKSPACE_DIR/failed_case_logs/" ]; then
            echo "[ERROR] Some test cases failed, please check failed_case_logs/. "
            exit 1
          else
            echo "[INFO] All test cases passed. "
          fi
      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: smoke_test_results
          path: "*.tar.gz"
          retention-days: 7